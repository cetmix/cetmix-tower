<?xml version="1.0" encoding="utf-8" ?>
<!-- Copyright (C) 2023 Cetmix OÃœ
     License AGPL-3.0 or later (https://www.gnu.org/licenses/agpl). -->
<odoo>

    <record
        id="cx_tower_file_template_dockerfile_git_aggregator"
        model="cx.tower.file.template"
    >
        <field name="name">Dockerfile with git aggregator</field>
        <field name="file_name">Dockerfile</field>
        <field name="server_dir">{{ dockerfile_location }}</field>
        <field name="note">Official Odoo image is used.
            Git aggregator is used for cloning complex repo configurations.
            Ensure git-aggregator.yml file is present.</field>

        <field name="code">
            FROM odoo:{{ odoo_version }}

            ARG ODOO_BRANCH={{ odoo_version }}
            ARG GITHUB_TOKEN=&lt;token&gt;
            ARG ODOO_ADDONS_TMP_LOCATION=/tmp/odoo-addons
            ARG ODOO_ADDONS_LOCATION=/opt/odoo/extra-addons

            USER root

            # Install git
            RUN DEBIAN_FRONTEND=noninteractive apt update &amp;&amp; \
                apt-get install -qy --no-install-recommends \
                git build-essential python3-pip python3-dev libffi-dev libssl-dev libsasl2-dev libxslt1-dev libldap2-dev libcups2 pkg-config libxmlsec1 libxmlsec1-dev

            # Configure git
            RUN git config --global user.email {{ git_config_user_email }} &amp;&amp; git config --global user.name {{ git_config_user_name }}

            WORKDIR ${ODOO_ADDONS_TMP_LOCATION}

            # Install git-aggregator and tools for requirements generation
            RUN pip3 install --upgrade pip &amp;&amp; pip install manifestoo setuptools-odoo git-aggregator --ignore-installed PyYAML

            # Copy git-aggregator.yml
            COPY ./git-aggregator.yml ${ODOO_ADDONS_TMP_LOCATION}

            # Run git-affregator
            RUN gitaggregate -c  git-aggregator.yml --expand-env

            # Make default
            RUN find . -type d -maxdepth 2 -exec setuptools-odoo-make-default --addons-dir={} --odoo-version-override=${ODOO_BRANCH} \;

            # Build requirements
            RUN find . -type d -maxdepth 2 -exec setuptools-odoo-get-requirements --addons-dir={} --output={}/requirements.txt \;

            # Merge all requirements into a single file
            RUN find ./ -mindepth 0 -name requirements.txt  -exec  cat {} &gt; all_requirements.txt +

            # Move all modules to the final destination
            RUN mkdir -p ${ODOO_ADDONS_LOCATION} &amp;&amp; \
                find . -mindepth 2 -maxdepth 2 -type d -not \( -name '.*' -o -name 'setup' \) -exec cp -r {} ${ODOO_ADDONS_LOCATION} \; \
                &amp;&amp; ls -lah ${ODOO_ADDONS_LOCATION} \
                &amp;&amp; chown -R odoo ${ODOO_ADDONS_LOCATION}


            # Install requirements
            RUN find ./ -mindepth 0 -name requirements.txt  -exec  cat {} &gt; all_requirements.txt + \
            &amp;&amp; pip3 install -r all_requirements.txt

            # Remove tmp location
            RUN rm -rf ${ODOO_ADDONS_TMP_LOCATION}

            # Let's go!
            USER odoo

        </field>

    </record>


    <record id="cx_tower_file_template_odoo_config" model="cx.tower.file.template">
        <field name="name">Odoo config</field>
        <field name="file_name">odoo.conf</field>
        <field name="server_dir">{{ odoo_config_location }}</field>

        <field name="code">
[options]
addons_path = /opt/odoo/extra-addons
admin_passwd = {{ odoo_db_manager_password }}

        </field>

    </record>


    <record
        id="cx_tower_file_template_git_aggregator_yml"
        model="cx.tower.file.template"
    >
    <field name="name">Git Aggregator Config</field>
    <field name="file_name">git-aggregator.yml</field>
    <field name="server_dir">{{ dockerfile_location }}</field>
    <field name="note">This file is used by the git-aggregator tool

        IMPORTANT: ensure that Git Aggregator directories are not overwritten by the direct Git cloned ones</field>

    <field name="code">
        <![CDATA[
./project:
    remotes:
        remote_1: https://github.com/OCA/project.git
    merges:
        -
            remote: remote_1
            ref: "16.0"    
    target: remote_1 16.0
    ]]>
    </field>

</record>



</odoo>
